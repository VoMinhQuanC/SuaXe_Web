<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ƒêƒÉng nh·∫≠p th√†nh c√¥ng - S·ª≠a Xe Nhanh</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <!-- Th√™m favicon t·ª´ CDN -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üîß</text></svg>">
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #f8f9fa;
        }
        .success-container {
            text-align: center;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            background-color: white;
            max-width: 500px;
            width: 90%;
        }
        .spinner-border {
            width: 3rem;
            height: 3rem;
            color: #0d6efd;
        }
        .logo-container {
            width: 80px;
            height: 80px;
            margin: 0 auto 1rem auto;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 50px;
            color: #0d6efd;
        }
        .avatar-container {
            width: 60px;
            height: 60px;
            margin: 0 auto 1rem auto;
            border-radius: 50%;
            background-color: #e9ecef;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 30px;
            color: #6c757d;
        }
        /* Th√™m m·ªõi: Ch·ªâ th·ªã g·ª° l·ªói */
        .debug-info {
            margin-top: 20px;
            text-align: left;
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="success-container">
        <!-- S·ª≠ d·ª•ng icon t·ª´ Bootstrap thay v√¨ h√¨nh ·∫£nh -->
        <div class="logo-container">
            <i class="bi bi-tools"></i>
        </div>
        
        <!-- Container cho avatar -->
        <div id="user-avatar" style="display: none;" class="avatar-container">
            <i class="bi bi-person"></i>
        </div>
        
        <div class="spinner-border mb-4" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        
        <h3 class="mb-3">ƒêƒÉng nh·∫≠p th√†nh c√¥ng!</h3>
        <p class="mb-2" id="welcome-message">Ch√†o m·ª´ng b·∫°n ƒë√£ quay tr·ªü l·∫°i!</p>
        <p class="mb-4">ƒêang chuy·ªÉn h∆∞·ªõng ƒë·∫øn trang ch·ªß...</p>
        <div id="error-message" class="alert alert-danger" style="display: none;"></div>
        
        <!-- Th√™m m·ªõi: Debug info -->
        <div id="debug-info" class="debug-info"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // L·∫•y th√¥ng tin t·ª´ URL
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            const userParam = urlParams.get('user');
            const errorElement = document.getElementById('error-message');
            const userAvatar = document.getElementById('user-avatar');
            const welcomeMessage = document.getElementById('welcome-message');
            const debugInfo = document.getElementById('debug-info');
            
            // Hi·ªÉn th·ªã debug khi nh·∫•n Shift + D
            document.addEventListener('keydown', function(e) {
                if (e.shiftKey && e.key === 'D') {
                    debugInfo.style.display = debugInfo.style.display === 'none' ? 'block' : 'none';
                }
            });

            // Lu√¥n hi·ªÉn th·ªã icon ng∆∞·ªùi d√πng
            userAvatar.style.display = 'flex';

            if (token && userParam) {
                try {
                    // Parse user JSON
                    const user = JSON.parse(decodeURIComponent(userParam));
                    
                    // L∆∞u th√¥ng tin ƒëƒÉng nh·∫≠p v√†o localStorage
                    localStorage.setItem('token', token);
                    localStorage.setItem('user', JSON.stringify(user));
                    
                    // C·∫≠p nh·∫≠t th√¥ng ƒëi·ªáp ch√†o m·ª´ng
                    if (user.fullName) {
                        welcomeMessage.textContent = `Ch√†o m·ª´ng ${user.fullName} ƒë√£ quay tr·ªü l·∫°i!`;
                    }
                    
                    // Debug
                    console.log('User info:', user);
                    
                    // Hi·ªÉn th·ªã th√¥ng tin ng∆∞·ªùi d√πng ƒë·ªÉ debug
                    debugInfo.innerHTML = `
                        <h5>Debug Info:</h5>
                        <p>User Data:</p>
                        <pre>${JSON.stringify(user, null, 2)}</pre>
                    `;
                    
                    // Ki·ªÉm tra c√°c tr∆∞·ªùng role kh√°c nhau
                    const role = user.role || user.roleId || user.roleID || user.RoleID || user.Role;
                    console.log('Role detected:', role);
                    
                    // Chuy·ªÉn h∆∞·ªõng d·ª±a tr√™n vai tr√≤ ng∆∞·ªùi d√πng
                    setTimeout(() => {
                        // Chuy·ªÉn ƒë·ªïi role th√†nh s·ªë n·∫øu n√≥ l√† chu·ªói
                        const roleValue = parseInt(role) || role;
                        
                        if (roleValue === 1) {
                            // Admin
                            console.log('Redirecting to admin.html');
                            window.location.href = 'admin.html';
                        } else if (roleValue === 3) {
                            // K·ªπ thu·∫≠t vi√™n
                            console.log('Redirecting to mechanic-dashboard.html');
                            window.location.href = 'mechanic-dashboard.html';
                        } else {
                            // Kh√°ch h√†ng th√¥ng th∆∞·ªùng
                            console.log('Redirecting to index.html for role:', roleValue);
                            window.location.href = 'index.html';
                        }
                    }, 2000);
                } catch (error) {
                    console.error('L·ªói khi x·ª≠ l√Ω d·ªØ li·ªáu ng∆∞·ªùi d√πng:', error);
                    errorElement.textContent = 'ƒê√£ x·∫£y ra l·ªói khi x·ª≠ l√Ω th√¥ng tin ƒëƒÉng nh·∫≠p.';
                    errorElement.style.display = 'block';
                    
                    // Chuy·ªÉn v·ªÅ trang ƒëƒÉng nh·∫≠p sau 3 gi√¢y
                    setTimeout(() => {
                        window.location.href = 'login.html?error=invalid_user_data';
                    }, 3000);
                }
            } else {
                // Kh√¥ng c√≥ token ho·∫∑c th√¥ng tin ng∆∞·ªùi d√πng
                errorElement.textContent = 'Th√¥ng tin ƒëƒÉng nh·∫≠p kh√¥ng h·ª£p l·ªá ho·∫∑c b·ªã thi·∫øu.';
                errorElement.style.display = 'block';
                
                // Chuy·ªÉn v·ªÅ trang ƒëƒÉng nh·∫≠p sau 3 gi√¢y
                setTimeout(() => {
                    window.location.href = 'login.html?error=missing_auth_data';
                }, 3000);
            }
        });
    </script>
</body>
</html>